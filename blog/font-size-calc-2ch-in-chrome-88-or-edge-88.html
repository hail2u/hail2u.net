<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta content="light dark" name="color-scheme">
    <meta content="same-origin" name="view-transition">
    <meta content="width=device-width, initial-scale=1" name="viewport">

    <title>Chrome 88やEdge 88でのfont-size: calc(2ch)</title>

    <style>
      body {
        font-family: sans-serif;
        font-size: 112.5%;
        margin-block-end: 25svh;
      }

      pre {
        white-space: pre-wrap;
      }

      figure {
        margin-inline: 0;
      }

      img,
      svg {
        block-size: auto;
        max-inline-size: 100%;
      }
    </style>
  </head>

  <body>
    <p><time>2021-02-09</time></p>

    <h1>Chrome 88やEdge 88でのfont-size: calc(2ch)</h1>

    <p>利用しているフォントの「0」のグリフ幅によって変わる<a href="https://www.w3.org/TR/css-values-3/#ch"><code>ch</code>単位</a>は、実装されて久しい。これを、<code>font-size</code>プロパティーで<code>calc()</code>や<code>clamp()</code>など計算するCSS関数を通して使うと、<a href="/pub/test/703.html">Chrome 88やEdge 88で想定より大きくなってしまうバグ</a>があるようだ。Firefox 85やSafari 14では問題なく、また<code>width</code>プロパティーなどでなら発生しない。</p>

<pre><code class="language-css">.test .raw {
  font-size: 2ch;
}

.test .calc {
  font-size: calc(2ch);
}</code></pre>

<p>このようなコードで再現する。同じ大きさ(16px前後)になるはずだが、Chrome 88やEdge 88で<code>.calc</code>の方が倍の大きさになってしまう。例えばNoto Sans CJK JPだと、17.76pxのはずが35.52pxになった。</p>

<p>2度計算してしまっているような気がするが、<code>3ch</code>にしても倍なので、そういうわけでもないようだ。単に<code>1ch</code>が倍に解釈されてしまうように見える。とにかく挙動不審だ。解決策もなさそうで、使わないようにするしかない。フォントによって変わるサイズを利用する時は頭に入れておくべきだろう。<code>ex</code>単位でも発生する(<code>cap</code>や<code>lh</code>単位は実装がない)。</p>

<hr>

<p>このウェブサイトのカラム幅を<code>ch</code>単位で指定しようとしたら、まんまと遭遇した。<code>html</code>要素の文字サイズを描画領域幅とカラム幅の差から計算していたので、ぴったりとこのような使い方になっていた。変わったことをしている自覚はあったので、すぐに気づけた。カスタム・プロパティーで定義、それを使って計算、というような書き方だと、どこでどのような単位を使っているか忘れてしまうので、遭遇しやすいかもしれない。</p>

<section>
<h2>追記</h2>

<p>このバグはどうもWindows 10でスケーリングを200%にすると起こるようだ。100%にすると起こらず、150%にすると1.5倍になった。高解像度なWindows 10のパソコンはそこそこ存在すると思うので、気をつける必要があるし、エミュレーター(スケーリングが100%のまま)などでは気づけない可能性も高いので、より注意が必要かもしれない。</p>
</section>
  </body>
</html>
