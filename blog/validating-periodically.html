<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta content="light dark" name="color-scheme">
    <meta content="same-origin" name="view-transition">
    <meta content="width=device-width, initial-scale=1" name="viewport">

    <title>HTMLファイルの定期的な検証</title>

    <style>
      body {
        font-family: sans-serif;
        font-size: 112.5%;
        margin-block-end: 25svh;
      }

      pre {
        white-space: pre-wrap;
      }

      figure {
        margin-inline: 0;
      }

      img,
      svg {
        block-size: auto;
        max-inline-size: 100%;
      }
    </style>
  </head>

  <body>
    <p><time>2020-12-23</time></p>

    <h1>HTMLファイルの定期的な検証</h1>

    <p>たまに変なテンプレートを書いてしまっていて、HTMLがおかしくなったりする。今回は<code>&lt;a href=&quot;/statuses/&quot;&quot;&gt;</code>と、引用符が重なっていたりした。しかし、テンプレート・ファイルが小間切れである以上、編集時に行うことは難しいだろう。やはり定期的に生成されたHTMLファイルを検証することになる。まずは、バージョン番号を更新したタイミングで、一部を検証することにした。</p>

<p>全HTMLファイルを検証するとなると死にそうなので、無作為に抽出して検証するしかない。一方で頻繁に更新される可能性のあるHTMLファイルは毎回検証すべきだ。つまり雑記記事からは無作為に抽出し、トップページ他のページ群と合わせて検証すれば十分だろう。抽出のデータ元としてはSitemapsファイルが最適だと考えて、それをうまく使うことにした。</p>

<p>まずはローカルで検証することにする。JSONでエラーを返してもらえる<a href="https://validator.w3.org/nu/">Nu HTML Checker</a>に対して、<a href="https://github.com/node-fetch/node-fetch">node-fetchパッケージ</a>と<a href="https://github.com/form-data/form-data">form-dataパッケージ</a>を使ってリクエストすると、機能と速度のバランスがよかった。Nuはmultipart/form-dataしか受け付けないので、form-dataパッケージが必要になる。</p>

<p>特に汎用化する必要もないので、<a href="https://github.com/hail2u/hail2u.net/blob/main/bin/random-validator.js">専用のスクリプト</a>と<a href="https://github.com/hail2u/hail2u.net/blob/main/lib/validate-html.js">エラーだけ調べるライブラリー</a>として書いた。汎用化されたものはnpmレジストリーにいっぱい公開、公式のパッケージも含めて公開されているので、ちゃんとしたプロジェクトではそっちを使う方がいい。このウェブサイトでは、どういうタイミングでやると効率的かつ修正しやすいかを探りたいので、小さく作って使ってみている。</p>

<p>検証のタイミングを探るため、雑記記事をプレビューして確認する時や公開する時にも検証するようにした。公開時よりもプレビュー時の方が、作業の一環として行え、直しやすいことがわかる。また、プレビューしないことはまずないので、公開時は不要かもしれない。</p>
  </body>
</html>
