<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">

    <title>検索フォームとそれへのページ内リンクによるフォーカス</title>

    <style>
      body {
        font-family: sans-serif;
        font-size: 112.5%;
        margin-block-end: 25svh;
      }

      pre {
        white-space: pre-wrap;
      }

      figure {
        margin-inline: 0;
      }

      img,
      svg {
        block-size: auto;
        max-inline-size: 100%;
      }
    </style>
  </head>

  <body>
    <p><time>2017-04-04</time></p>

    <h1>検索フォームとそれへのページ内リンクによるフォーカス</h1>

    <p>検索フォームへは移動と同時にフォーカスもさせたい。そうしておかないと、入力可能にするにはもう一度クリックしなくてはならず、フラストレーションがたまるからだ。このウェブサイトでは<code>input[type=&quot;search&quot;]</code>にIDを振ることで実現しておいた。HTMLコードだけで実装できる。しかし、Firefox 54やMobile Safari 10.2ではうまくフォーカスが当たってくれない。</p>

<p>Demo: <a href="/test/670.html">Fragment ID and Focus Management</a></p>

<p>Firefox 54ではフォーカス順の位置は入力ボックスの位置に移るが、入力可能な状態にはならない。Mobile Safari 10.2では入力ボックスがズームされ、キーボードが出てくるが、実際には入力することはできない。</p>

<p><a href="https://html.spec.whatwg.org/multipage/browsers.html#scroll-to-fragid">フラグメントをたどる仕様</a>によると「Run the focusing steps for target」というステップが存在する。それならばフォーカスが当たるのが正しいはずだ。Firefox 54やMobile Safari 10.2のバグと言えるだろう。とはいうものの、仕様の後出しのようなので、まだ反映されていないだけとも言える。</p>

<p>バグだ！　と言っててもしょうがないので、JavaScriptでフォローした方が良いかもしれない。JavaScriptで制御する場合は、リンクをジャックするのではなく、<code>hashchange</code>イベントを利用すると良さそうだ。DOM構築を待つ必要がないため、低コストで初期化できるはずだ。</p>

<hr>

<p>今のところブラウザーのせいにして何もしていない。Firefoxはともかくとして、Mobile Safari 10.3で治っていなかったら直すつもりだ。</p>

<p>Firefoxには12年前からバグが立っていた。仕様の更新を受け、実装作業が進んでいるようだ。Safariにも同じようなバグがあり、パッチも登録されている。挙動が統一される可能性は高い。</p>

<section>
<h2>追記</h2>

<p>iOS 10.3に上げて確認したところうまくフォーカスが当たらないままだったので、とりあえずという形で当たるようにしておいた。Mobie Safariの<code>click</code>イベントなどからしかフォーカスを制御できないという仕様のことをすっかり忘れていたので、なかなか面倒な感じになっている。それだけで済めばまだよかったのだが、Firefox 54では<code>click</code>イベントのコードを実行した<em>あとに</em>ブラウザー側のフォーカス制御が行われるようで、こっちはこっちで<code>hashchange</code>イベントを利用しなければならなかった。</p>
</section>
  </body>
</html>
