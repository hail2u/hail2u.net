<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">

    <title>JSONファイルをDynamic Import</title>

    <link title="ウェブサイト全体のRSS" href="/feed" rel="alternate" type="application/rss+xml">
    <link title="雑多な記録だけのRSS" href="/blog/feed" rel="alternate" type="application/rss+xml">
    <link href="mailto:hail2u@gmail.com" rel="author">
    <link href="https://hail2u.net/blog/using-dynamic-import-for-a-json-file.html" rel="canonical">
    <meta content="JSONファイルを読み込むのにfsモジュールを使っているが、Dynamic Importでも書けるようなので置き換えてみている、いや、いた。実装が遅れていたFirefoxも、2025年4月末にリリースされた138でサポートしたので、試してみる気になった。短くならない上に、可読性も良くないことがわかる。import宣言ならJSONファイルを読み込む価値はあるが、かなり特別な理由がない限りDynamic ImportをJSONファイルの読み込みに使うことはやめた方が良さそうだ。" name="description">
    <link href="/favicon.svg" rel="icon" type="image/svg+xml">
    <link href="https://creativecommons.org/licenses/by/4.0/" rel="license">
    <link href="https://m.media-amazon.com/" rel="preconnect">
    <link href="https://duckduckgo.com/?q=site%3Ahail2u.net" rel="search">

    <link href="/css/print.css?v=9.35.3" media="only print" rel="stylesheet">
    <link href="/css/index.css?v=9.35.3" media="only screen" rel="stylesheet">
  </head>

  <body>

      <nav id="top">
        <p class="back"><a href="/"><span role="img" aria-label="ホームへ戻る">←</span></a></p>
      </nav>

      <header class="page-header">
          <p class="date"><time datetime="2025-06-25T10:58:33+09:00">2025年6月25日</time></p>

        <h1><em>JSONファイルをDynamic Import</em></h1>
      </header>

    <main>
      <p>JSONファイルを読み込むのにfsモジュールを使っているが、Dynamic Importでも書けるようなので置き換えてみている、いや、いた。実装が遅れていたFirefoxも、2025年4月末にリリースされた138でサポートしたので、試してみる気になった。短くならない上に、可読性も良くないことがわかる。<code>import</code>宣言ならJSONファイルを読み込む価値はあるが、かなり特別な理由がない限りDynamic ImportをJSONファイルの読み込みに使うことはやめた方が良さそうだ。</p>

<pre><code class="language-javascript">import assert from &quot;node:assert&quot;;
import fs from &quot;node:fs/promises&quot;;

const obj1 = await fs.readFile(&quot;./test.json&quot;).then(JSON.parse);
const <mark>{ default: obj2 }</mark> = await import(&quot;./test.json&quot;, <mark>{
  with: { type: &quot;json&quot; }
}</mark>);
assert.deepStrictEqual(obj1, obj2);</code></pre>

<p>fsモジュールではBufferとして読んで、<code>JSON.parse()</code>に流す。1行で無理やり書いた感がすごい。これを書き換えたい動機としては、<code>utf8</code>と書かずに済むくらいの感覚で、<code>then</code>と<code>JSON.parse()</code>を書きたくないということに尽きる。fs-extraパッケージを使う気はないが、あれくらい短くスパッと書きたい。</p>

<p>Dynamic Importだと、<code>import()</code>の第二引数で<code>import</code>宣言と同じ<code>with</code>キーを使ってJSONファイルを読み込むことを教えれば良い。これだけだったら使いやすそうに思えるが、既定で<code>default</code>キーへJSONファイルの内容が展開されるので、分解文法を使って代入しないと使いづらい。そして<code>default</code>は予約語のため名前も変える必要がある。そんなこんなでなかなか長い。</p>

<p>長いだけならまだしも、{}が3組もあってかなり読みづらい。Dynamic Importの方が速そうな気はするが、それでも使う気は起きない。またうっかり<em>ドットで始まらない相対パス</em>を投げてしまうと、<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import#module_specifier_resolution">Bare Specifier</a>とみなされて死ぬことも致命的な気配がある。上記例だと<code>test.json</code>と書いてしまうと、 Node.jsでは<code>test.json</code>という名前のパッケージを探しに行き、ERR_MODULE_NOT_FOUNDになるだろう。</p>
    </main>

    <footer class="page-footer">

        <p>このウェブサイトは<a href="mailto:hail2u@gmail.com">ながしまきょう</a>が<a title="Creative Commons (表示)" href="https://creativecommons.org/licenses/by/4.0/">CC-BY</a>の下で作成、公開、そして更新しています。更新情報は<a href="/feed" type="application/rss+xml">RSS</a> (<a href="/blog/feed" type="application/rss+xml">雑多な記録だけのRSS</a>)で購読できます。その他、わからないことは<a href="/#about">もう少し詳しい情報</a>を参照してください。</p>

      <p><a href="#top"><span aria-hidden="true">↑ </span>一番上</a></p>
    </footer>
  </body>
</html>
