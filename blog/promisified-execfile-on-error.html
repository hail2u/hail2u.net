<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta content="light dark" name="color-scheme">
    <meta content="width=device-width" name="viewport">

    <title>Promise化されたexecFile()でのエラー</title>

    <link title="ウェブサイト全体のRSS" href="/feed" rel="alternate" type="application/rss+xml">
    <link title="記事だけのRSS" href="/blog/feed" rel="alternate" type="application/rss+xml">
    
    
    
    <link href="/apple-touch-icon.png" rel="apple-touch-icon">
    <link href="mailto:hail2u@gmail.com" rel="author">
    <link href="https://hail2u.net/blog/promisified-execfile-on-error.html" rel="canonical">
    <meta content="child_processモジュールの関数群もutil.promisify()を使ってPromise化できる。しかしexecFile()などは元々のコールバックに3つ引数が渡されることから少し使い方が違ってくる。ここまでは皆が通る道だろう。実はそれだけでなくリジェクトされた時も少し違うことが公式ドキュメントの該当する項の最後に記載されていた。" name="description">
    <link href="/favicon.svg" rel="icon" type="image/svg+xml">
    <link href="https://creativecommons.org/licenses/by/4.0/" rel="license">
    <link href="https://duckduckgo.com/?q=site%3Ahail2u.net" rel="search">

    <link href="/css/print.css?v=9.33.0" media="only print" rel="stylesheet">
    <link href="/css/index.css?v=9.33.0" media="only screen" rel="stylesheet">
  </head>

  <body>

      <nav id="top">
        <p class="logo"><a href="/"><span aria-label="ホームへ戻る">←</span></a></p>
      </nav>

      <header class="page-header">
          <p class="date"><time datetime="2018-02-11T14:26:25+09:00">2018年2月11日</time></p>

        <h1><em>Promise化されたexecFile()でのエラー</em></h1>
      </header>

    <main>
      <p><code>child_process</code>モジュールの関数群も<code>util.promisify()</code>を使ってPromise化できる。しかし<code>execFile()</code>などは元々のコールバックに3つ引数が渡されることから少し使い方が違ってくる。ここまでは皆が通る道だろう。実はそれだけでなくリジェクトされた時も少し違うことが<a href="https://nodejs.org/api/child_process.html#child_process_child_process_execfile_file_args_options_callback">公式ドキュメントの該当する項の最後</a>に記載されていた。</p>

<blockquote>
<p>In case of an error, a rejected promise is returned, with the same <code>error</code> object given in the callback, but with an additional two properties <code>stdout</code> and <code>stderr</code></p>
</blockquote>

<p>ちゃんと<code>catch()</code>されているなら、エラーが起きた場合にその中で標準出力と標準エラーにアクセスできるわけだ。こうなっていることでプロミス化した<code>execFile()</code>を<code>await</code>してエラーになった時、その解決に必要になる重要なメッセージを記録でき、実行したファイルが起こしたエラーの解決につなげられる。</p>

<pre><code class="language-javascript">const util = require(&quot;util&quot;);
const { execFile } = require(&quot;child_process&quot;);
const execFileAsync = util.promisify(execFile);

const getVersion = async () =&gt; {
  const { stdout } = await execFile(&quot;node&quot;, [&quot;--version&quot;]);
  console.log(stdout);
};

getVersion().catch(e =&gt; {
  if (e.stderr) {
    console.error(e.stderr);
  }

  console.trace(e);
});</code></pre>

<p>Promiseの<code>catch()</code>側でやる。これはこれで専用の<code>catch()</code>を書くことになるのがちょっと気になる。大抵の場合は<code>Error</code>オブジェクトがいい感じになっているような気がするので、実はあまり考えなくて良いのかもしれない。</p>

<hr>

<p>僕は当初<code>try..catch</code>でやるものと考えていて、書きづらいな……と感じていた。</p>

<pre><code class="language-javascript">const util = require(&quot;util&quot;);
const { execFile } = require(&quot;child_process&quot;);
const execFileAsync = util.promisify(execFile);

const getVersion = async () =&gt; {
  let stdout;
  let stderr;

  try {
    ({ stdout, stderr }) = await execFileAsync(&quot;node&quot;, [&quot;--version&quot;]);
  } catch (e) {
    console.error(stderr);
    throw e;
  }

  console.log(stdout);
};

getVersion().catch(e =&gt; {
  console.trace(e);
});</code></pre>

<p><code>let</code>を前出ししたり、そのおかげで<code>await</code>で受け取る時に<code>()</code>で括らなければならない。結局はそれ以前の問題で、これでは<code>catch</code>節で<code>stderr</code>が拾えない。</p>
    </main>

    <footer class="page-footer">
      <hr>

        <p>このウェブサイトは<a href="mailto:hail2u@gmail.com">ながしまきょう</a>が<a title="Creative Commons (表示)" href="https://creativecommons.org/licenses/by/4.0/">CC-BY</a>の下で作成、公開、そして更新しています。更新情報は<a href="/feed" type="application/rss+xml">RSS</a> (<a href="/blog/feed" type="application/rss+xml">記事だけのRSS</a>)または<a href="https://x.com/hail2u_">X</a>で購読できます。その他、わからないことは<a href="https://hail2u.net/about/">もう少し詳しい情報</a>を参照してください。</p>

      <p><a href="#top"><span aria-hidden="true">↑ </span>一番上</a></p>
    </footer>
  </body>
</html>
