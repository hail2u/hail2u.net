<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">

    <title>Date.parse(&quot;2015-02-31&quot;)</title>

    <style>
      body {
        font-family: sans-serif;
        font-size: 112.5%;
        margin-block-end: 25svh;
      }

      pre {
        white-space: pre-wrap;
      }

      figure {
        margin-inline: 0;
      }

      img,
      svg {
        block-size: auto;
        max-inline-size: 100%;
      }
    </style>
  </head>

  <body>
    <p><time>2019-07-19</time></p>

    <h1>Date.parse(&quot;2015-02-31&quot;)</h1>

    <p>ES5以降では、<code>Date.parse()</code>に不正な日時を渡した場合、<code>NaN</code>を返す……が、不正な日時の解釈に実装によって違いがあることを今さら知った。タイトルのように2015-02-31を渡すと、Firefox 67は<code>NaN</code>を返すが、Chrome 75などでは良きにはからって、つまり2015-03-03とみなしてくれる。書式そのものの解釈の違いだけでなく、こんなところにも非互換性が埋まっていて、まんまとハマった。</p>

<p>Chrome 75やEdge 18、Node.js v12.0.0では以下のようになる。対してFirefox 67は2番目のみ<code>NaN</code>を返す。</p>

<pre><code>console.log(Date.parse("2015-02-28")); // 1425081600000
console.log(Date.parse("2015-02-31")); // 1425340800000
console.log(Date.parse("2015-03-03")); // 1425340800000</code></pre>

<p>セケンでは<a href="https://momentjs.com/">Moment.js</a>か何かを使い、<code>Date</code>オブジェクトには一切触らないはずなので、あまり問題にならない。小さな書き捨てスクリプトで、おおむね日時っぽい文字列を何やらやる時にハマるかもしれない。</p>

<hr>

<p>ES5の仕様では不正な日時なら<code>NaN</code>を返すとなっているが、どうなっていると不正なのかは明確ではない。日付と時刻の書式でDDは01から31まで許可されているので、2015-02-31は書式として正しく、不正な日時ではないと考えられる。一方で2015-02-31は存在しない日付なので、不正な日時だとも考えられる。</p>

<p>不正な日時の定義があいまいである以上、どちらの実装も間違ってはいない。のかもしれない。と思う。よう知らんけど。</p>
  </body>
</html>
