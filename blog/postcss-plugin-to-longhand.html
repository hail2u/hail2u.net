<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">

    <title>PostCSSプラグイン: to-longhand</title>

    <style>
      body {
        font-family: sans-serif;
        font-size: 112.5%;
        margin-block-end: 25svh;
      }

      pre {
        white-space: pre-wrap;
      }

      figure {
        margin-inline: 0;
      }

      img,
      svg {
        block-size: auto;
        max-inline-size: 100%;
      }
    </style>
  </head>

  <body>
    <p><time>2018-08-31</time></p>

    <h1>PostCSSプラグイン: to-longhand</h1>

    <p>Edge 17にあるカスタム・プロパティーとショートハンド・プロパティーでのバグが、パッチ・レベルでは直りそうもない。つまり、そう簡単には世界から消えてくれないことが確定してしまったため、しばらく(最低1年半くらい)の間ロングハンド・プロパティーで書かなくてはならない。しかし、そう書き直されたCSSを見ていると、とにかく悲しいので、<a href="https://github.com/hail2u/hail2u.net/blob/6a84d5993084df8002737563c10c940f94448495/lib/to-longhand.js"><code>to-longhand</code>というPostCSSプラグイン</a>を書いて誤魔化すことにした。</p>

<p><code>margin</code>や<code>padding</code>プロパティーの変換は簡単だ。まず4値の指定に変換し、それから上右下左に割り当てるだけだ。</p>

<p><code>border</code>プロパティー群のショートハンドの変換は難しい。歴史的に幅、スタイル、色の順で書かれることが多いようだし、僕もそう書いているので、それで決め打ちということにした。</p>

<hr>

<p>ヒマがあったら順不同に対応できるように書き直したい、と考えていたが、どうやら無理そうだ。どのような値が指定されているのかざっと調べれば良いと単純にとらえていたが、問題になるのはカスタム・プロパティーなので、ランタイム、すなわちブラウザーでレンダリングされるまで値がどのようなものか確定しない。</p>

<pre><code class="language-css">:root {
  --foo: double;
  --bar: 3px;
}

.test {
  border: var(--foo) var(--bar);
}</code></pre>

<p>恣意的なコードを出すと、こういう<code>border</code>プロパティーがありうる。<code>--foo</code>を辿ると<code>double</code>、同じように<code>--bar</code>を辿ると<code>3px</code>なので、このプロパティーからは以下のようなロングハンド・プロパティー群が生成できるだろう。</p>

<pre><code class="language-css">.test {
  border-style: var(--foo);
  border-width: var(--bar);
}</code></pre>

<p>一見、これで良さそうだが、カスタム・プロパティーなので、その値がいつも同じタイプであるとは限らない。別のルールセット内で上書き定義されることもあるからだ。</p>

<pre><code class="language-css">.test2 {
  --foo: #f0f;
}</code></pre>

<p>トリッキーに書くなら、このようにして色とスタイルを同時に変更できる。この場合、生成した<code>border-style</code>プロパティーで色を指定することになってしまうので、無視される。</p>

<p>「このCSSがおかしい」というのは確かだろう。しかし、カスタム・プロパティーは汎用的なものなので、思っても見ない形でこういったケースに遭遇する可能性が高い。ロングハンド・プロパティーへの展開を汎用的に作ることはあきらめ、ショートハンド・プロパティーの書き方に(意見の一致が見られそうな)制限をかける方が無難だろう。</p>

<hr>

<p>変数(的な何か)がある、すなわち型が必要という話であるのかもしれない。TypeScript+CSSOMで書くみたいな未来もありえそうだ。</p>
  </body>
</html>
